<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File View - <%= file.original_filename %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .data-table {
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }
        .data-table td {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .data-table td:hover {
            overflow: visible;
            white-space: normal;
            word-wrap: break-word;
        }
        .encoding-issues {
            background-color: #fff3cd;
            color: #856404;
        }
        .japanese-text {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .data-type-badge {
            font-size: 10px;
            padding: 2px 4px;
        }
        .header-row {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        .data-row:nth-child(even) {
            background-color: #f8f9fa;
        }
        .file-stats {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/dashboard">
                <i class="fas fa-file-code me-2"></i>EDI Parser
            </a>
            <div class="navbar-nav ms-auto">
                <div class="dropdown">
                    <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user me-1"></i><%= user.username %> 
                        <span class="badge bg-secondary"><%= user.type %></span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/dashboard">Dashboard</a></li>
                        <% if (user.type === 'admin') { %>
                        <li><a class="dropdown-item" href="/logs">User Logs</a></li>
                        <% } %>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/logout">Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
                <li class="breadcrumb-item active">Japanese EDI File View</li>
            </ol>
        </nav>

        <!-- File Information -->
        <div class="file-stats">
            <h4><i class="fas fa-file-code me-2"></i><%= file.original_filename %></h4>
            <div class="row">
                <div class="col-md-6">
                    <small><strong>Uploaded by:</strong> <%= file.uploaded_by %></small><br>
                    <small><strong>Upload date:</strong> <%= new Date(file.upload_timestamp).toLocaleDateString() %></small><br>
                    <small><strong>File size:</strong> <%= file.file_size ? (file.file_size / 1024).toFixed(1) + ' KB' : 'Unknown' %></small>
                </div>
                <div class="col-md-6">
                    <% if (parsedData && parsedData.statistics) { %>
                    <small><strong>Total rows:</strong> <%= parsedData.statistics.totalSegments %></small><br>
                    <small><strong>Data rows:</strong> <%= parsedData.statistics.dataRows %></small><br>
                    <small><strong>Format:</strong> <%= parsedData.fileInfo ? parsedData.fileInfo.detectedFormat : 'Unknown' %></small><br>
                    <% if (parsedData.statistics.encodingIssuesDetected) { %>
                    <small><span class="badge bg-warning">‚ö†Ô∏è Encoding issues detected</span></small><br>
                    <% } %>
                    <% if (parsedData.statistics.japaneseTextDetected) { %>
                    <small><span class="badge bg-info">üáØüáµ Japanese text detected</span></small>
                    <% } %>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Tabs for different views -->
        <ul class="nav nav-tabs" id="fileTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="table-tab" data-bs-toggle="tab" 
                        data-bs-target="#table-view" type="button" role="tab">
                    <i class="fas fa-table me-2"></i>Table View
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="raw-tab" data-bs-toggle="tab" 
                        data-bs-target="#raw-view" type="button" role="tab">
                    <i class="fas fa-code me-2"></i>Raw Content
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" 
                        data-bs-target="#analysis-view" type="button" role="tab">
                    <i class="fas fa-chart-pie me-2"></i>Analysis
                </button>
            </li>
        </ul>

        <div class="tab-content" id="fileTabsContent">
            <!-- Table View -->
            <div class="tab-pane fade show active" id="table-view" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-body">
                        <% if (parsedData && parsedData.segments && parsedData.segments.length > 0) { %>
                        <div class="table-responsive">
                            <table class="table table-sm data-table">
                                <% parsedData.segments.forEach((segment, index) => { %>
                                <tr class="<%= segment.type === 'HEADER' ? 'header-row' : 'data-row' %>">
                                    <td style="width: 50px;"><strong><%= segment.index %></strong></td>
                                    <% if (segment.elements && segment.elements.length > 0) { %>
                                    <% segment.elements.forEach((element, elemIndex) => { %>
                                    <td title="<%= element %>" 
                                        class="<%= segment.containsEncodingIssues ? 'encoding-issues' : '' %> 
                                               <%= segment.containsJapanese ? 'japanese-text' : '' %>">
                                        <%= element %>
                                        <% if (segment.interpretedData && segment.interpretedData[elemIndex]) { %>
                                        <br><span class="badge data-type-badge bg-secondary">
                                            <%= segment.interpretedData[elemIndex].dataType %>
                                        </span>
                                        <% } %>
                                    </td>
                                    <% }); %>
                                    <% } %>
                                </tr>
                                <% }); %>
                            </table>
                        </div>
                        <% } else { %>
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>No Parsed Data</h6>
                            <p>The file could not be parsed into a table format. Check the raw content tab for details.</p>
                        </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Raw Content View -->
            <div class="tab-pane fade" id="raw-view" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between">
                        <h6><i class="fas fa-code me-2"></i>Raw File Content</h6>
                        <button class="btn btn-sm btn-outline-primary" onclick="copyRawContent()">
                            <i class="fas fa-copy me-1"></i>Copy
                        </button>
                    </div>
                    <div class="card-body">
                        <pre id="rawContent" class="bg-dark text-light p-3 rounded" 
                             style="max-height: 500px; overflow-y: auto; font-size: 12px;"><%= file.file_content %></pre>
                    </div>
                </div>
            </div>

            <!-- Analysis View -->
            <div class="tab-pane fade" id="analysis-view" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-body">
                        <% if (parsedData && parsedData.statistics) { %>
                        <h6><i class="fas fa-chart-pie me-2"></i>File Analysis</h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6>General Statistics</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Total segments:</strong> <%= parsedData.statistics.totalSegments %></li>
                                    <li><strong>Header rows:</strong> <%= parsedData.statistics.headerRows %></li>
                                    <li><strong>Data rows:</strong> <%= parsedData.statistics.dataRows %></li>
                                    <li><strong>Avg elements per row:</strong> <%= parsedData.statistics.averageElementsPerRow %></li>
                                    <li><strong>Max elements in row:</strong> <%= parsedData.statistics.maxElementsInRow %></li>
                                    <li><strong>Min elements in row:</strong> <%= parsedData.statistics.minElementsInRow %></li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Content Analysis</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Encoding issues:</strong> 
                                        <span class="badge bg-<%= parsedData.statistics.encodingIssuesDetected ? 'warning' : 'success' %>">
                                            <%= parsedData.statistics.encodingIssuesDetected ? 'Detected' : 'None' %>
                                        </span>
                                    </li>
                                    <li><strong>Japanese text:</strong> 
                                        <span class="badge bg-<%= parsedData.statistics.japaneseTextDetected ? 'info' : 'secondary' %>">
                                            <%= parsedData.statistics.japaneseTextDetected ? 'Detected' : 'None' %>
                                        </span>
                                    </li>
                                    <li><strong>Detected format:</strong> <%= parsedData.fileInfo.detectedFormat %></li>
                                    <li><strong>Suggested encoding:</strong> <%= parsedData.fileInfo.encoding %></li>
                                </ul>
                            </div>
                        </div>

                        <% if (parsedData.headers) { %>
                        <h6 class="mt-4">Header Analysis</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Index</th>
                                        <th>Original Text</th>
                                        <th>Possible Meaning</th>
                                        <th>Issues</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (parsedData.segments[0] && parsedData.segments[0].interpretedFields) { %>
                                    <% Object.values(parsedData.segments[0].interpretedFields).forEach((field, index) => { %>
                                    <tr>
                                        <td><%= index %></td>
                                        <td><code><%= field.originalText %></code></td>
                                        <td><%= field.possibleMeaning %></td>
                                        <td>
                                            <% if (field.hasEncodingIssues) { %>
                                            <span class="badge bg-warning">Encoding Issues</span>
                                            <% } %>
                                        </td>
                                    </tr>
                                    <% }); %>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                        <% } %>
                        <% } else { %>
                        <div class="alert alert-info">
                            <p>No analysis data available. The file may have parsing errors.</p>
                        </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function copyRawContent() {
            const content = document.getElementById('rawContent').textContent;
            navigator.clipboard.writeText(content).then(() => {
                alert('Content copied to clipboard!');
            });
        }

        // Make table cells expandable on click
        document.querySelectorAll('.data-table td').forEach(cell => {
            cell.addEventListener('click', function() {
                this.style.whiteSpace = this.style.whiteSpace === 'normal' ? 'nowrap' : 'normal';
                this.style.overflow = this.style.overflow === 'visible' ? 'hidden' : 'visible';
            });
        });
    </script>
</body>
</html>
